<!-- src/main/resources/templates/project/details.html -->
<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
  <meta charset="UTF-8"/>
  <title layout:fragment="title"
         th:text="'Детали проекта «' + ${project.name} + '»'">
    Детали проекта
  </title>
</head>

<body>
<div layout:fragment="content">
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <h2 class="text-center mb-4">Детальная страница проекта</h2>
      </div>
    </div>

    <!-- ======= Карточка проекта ======= -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0"
            th:text="'Детали проекта «' + ${project.name} + '»'">
          Детали проекта
        </h3>
      </div>

      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">Название</dt>
          <dd class="col-sm-8" th:text="${project.name}">Название</dd>

          <dt class="col-sm-4">Описание</dt>
          <dd class="col-sm-8" th:text="${project.description}">Описание</dd>

          <dt class="col-sm-4">Владелец</dt>
          <dd class="col-sm-8" th:text="${project.owner.username}">owner</dd>

          <dt class="col-sm-4">Приоритет</dt>
          <dd class="col-sm-8">
            <span th:switch="${project.priority}">
              <span th:case="1">Низкий</span>
              <span th:case="2">Средний</span>
              <span th:case="3">Высокий</span>
              <span th:case="*">—</span>
            </span>
          </dd>

          <dt class="col-sm-4">Команда</dt>
          <dd class="col-sm-8" th:text="${project.team != null ? project.team.name : '—'}">—</dd>
        </dl>
      </div>

      <div class="card-footer d-flex justify-content-between">
        <a th:href="@{/projects}" class="btn btn-outline-secondary">
          ← К списку проектов
        </a>

        <div>
          <a th:if="${project.owner.username == #authentication.name
                     or #authentication.principal.role == 'ROLE_ADMIN'}"
             th:href="@{|/projects/${project.id}/edit|}"
             class="btn btn-primary me-2">Редактировать</a>

          <form th:if="${project.owner.username == #authentication.name
                        or #authentication.principal.role == 'ROLE_ADMIN'}"
                th:action="@{|/projects/${project.id}/delete|}"
                method="post" style="display:inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit"
                    class="btn btn-danger"
                    onclick="return confirm('Удалить проект?');">
              Удалить
            </button>
          </form>
        </div>
      </div>
    </div>
    <!-- ======= /Карточка проекта ======= -->

    <!-- ======= Таблица задач проекта ======= -->
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Задачи проекта</h5>

        <a id="btnAddTask"
        th:if="${project.owner.username == #authentication.name
        or #authentication.principal.role == 'ROLE_ADMIN'}"
        th:href="@{|/projects/${project.id}/tasks/new|}"
        class="btn btn-success btn-sm">
        <i class="bi bi-plus-lg me-1"></i> Новая задача
        </a>
      </div>

      <div class="table-responsive">
        <table id="tasksTable"
        class="table table-hover mb-0">
        <thead class="table-light">
        <tr>
          <th>Название</th>
          <th>Статус</th>
          <th>Исполнитель</th>
          <th class="text-end">Действия</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="t : ${project.tasks}">
          <td th:text="${t.title}">Task title</td>
          <td th:text="${t.status}">TODO</td>
          <td th:text="${t.assignedUser != null ? t.assignedUser.username : '—'}">—</td>

          <td class="text-end">
            <!-- Единственная кнопка-глазик доступна всем -->
            <a th:href="@{|/projects/${project.id}/tasks/${t.id}|}"
               class="btn btn-sm btn-outline-secondary me-2"
               title="Просмотр">
              <i class="bi bi-eye"></i>
            </a>

            <!-- edit / delete только владельцу или ADMIN -->
            <a th:if="${project.owner.username == #authentication.name
                         or #authentication.principal.role == 'ROLE_ADMIN'}"
               th:href="@{|/projects/${project.id}/tasks/${t.id}/edit|}"
               class="btn btn-sm btn-outline-primary me-2"
               title="Редактировать">
              <i class="bi bi-pencil"></i>
            </a>

            <form th:if="${project.owner.username == #authentication.name
                            or #authentication.principal.role == 'ROLE_ADMIN'}"
                  th:action="@{|/projects/${project.id}/tasks/${t.id}/delete|}"
                  method="post" style="display:inline;">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <button class="btn btn-sm btn-outline-danger"
                      title="Удалить"
                      onclick="return confirm('Удалить задачу?');">
                <i class="bi bi-trash"></i>
              </button>
            </form>
          </td>
        </tr>

        <tr th:if="${#lists.isEmpty(project.tasks)}">
          <td colspan="4" class="text-center py-3">Задач нет</td>
        </tr>
        </tbody>
        </table>
      </div>
    </div>
    <!-- ======= /Таблица задач ======= -->

  </div>
</div>

<!-- ======= Модальное окно для AJAX-создания задачи ======= -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="taskForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Новая задача</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Название</label>
          <input name="title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Статус</label>
          <select name="status" class="form-select">
            <option value="TODO">TODO</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="DONE">DONE</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<!-- ======= JS ======= -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const projectId  = /*[[${project.id}]]*/ 0;
  const csrfHeader = /*[['${_csrf.headerName}']]*/ 'X-CSRF-TOKEN';
  const csrfToken  = /*[['${_csrf.token}']]*/ '';

  // ---------- открыть модалку ----------
  const btnAdd = document.getElementById('btnAddTask');
  if (btnAdd) btnAdd.addEventListener('click', e => {
    e.preventDefault();
    new bootstrap.Modal(document.getElementById('taskModal')).show();
  });

  // ---------- отправка формы ----------
  document.getElementById('taskForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const data = {
      title : form.title.value,
      status: form.status.value
    };

    const resp = await fetch(`/api/projects/${projectId}/tasks`, {
      method : 'POST',
      headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
      body   : JSON.stringify(data)
    });

    if (resp.ok) {
      const task = await resp.json();
      addRow(task);
      bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
      form.reset();
    } else {
      alert('Ошибка сохранения задачи');
    }
  });

  // ---------- добавить строку ----------
  function addRow(t) {
    const tbody = document.querySelector('#tasksTable tbody');
    const tr    = document.createElement('tr');
    tr.innerHTML = `
    <td>${t.title}</td>
    <td>${t.status}</td>
    <td>${t.assignedUsername ?? '—'}</td>
    <td class="text-end">
       <a href="/projects/${projectId}/tasks/${t.id}" class="btn btn-sm btn-outline-secondary me-2">
         <i class="bi bi-eye"></i>
       </a>
    </td>`;
    tbody.appendChild(tr);
  }
  /*]]>*/
</script>
</body>
</html>
