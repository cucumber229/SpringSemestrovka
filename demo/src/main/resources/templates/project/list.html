<!DOCTYPE html>
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8"/>
    <!-- Внутренние стили для страницы списка проектов -->
    <style>

        /* ==========================================
           СТИЛИ ДЛЯ СТРАНИЦЫ СПИСКА ПРОЕКТОВ
           ========================================== */
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(120deg, #f0f4f8 0%, #e1e8ee 100%);
            margin: 0;
            padding: 0;
        }
        .container.mt-4 {
            margin-top: 1rem;
        }
        .row.justify-content-center.mb-3 {
            margin-bottom: 1rem;
        }
        .row.g-2.align-items-center {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .row.g-2.align-items-center label {
            font-weight: 600;
            font-size: 1rem;
            color: #0d6efd;
        }
        .row.g-2.align-items-center select.form-select {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            font-size: 1rem;
            background: #fff;
            transition: border-color 0.15s;
        }
        .row.g-2.align-items-center select.form-select:focus {
            border-color: #0d6efd;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        .row.g-2.align-items-center .btn {
            background: #0083b0;
            color: #fff;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background 0.15s;
        }
        .row.g-2.align-items-center .btn:hover {
            background: #006994;
        }
        .card.shadow-sm {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .card-header.bg-primary.text-white.d-flex {
            background: #0d6efd !important;
            color: #fff !important;
            padding: 1rem 1.5rem;
        }
        .card-header.bg-primary.text-white.d-flex h3.mb-0 {
            font-weight: 600;
            font-size: 1.5rem;
            margin: 0;
        }
        .card-header .btn-success {
            background: #198754;
            color: #fff;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background 0.15s;
            font-size: 1rem;
            text-decoration: none;
        }
        .card-header .btn-success:hover {
            background: #146c43;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-hover tbody tr:hover {
            background: rgba(13, 110, 253, 0.05);
        }
        .table th, .table td {
            padding: 0.75rem 1rem;
            border: 1px solid #dee2e6;
        }
        .table thead th {
            background: #f8f9fa;
            color: #212529;
            font-weight: 600;
            text-align: left;
        }
        .table thead a {
            color: #0d6efd;
            text-decoration: none;
            position: relative;
        }
        .table thead a:hover {
            text-decoration: underline;
        }
        .table thead th a.text-white.bg-dark {
            background: #0d6efd;
            color: #fff !important;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
        }
        .table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }
        .btn-sm {
            font-size: 0.875rem;
            padding: 0.4rem 0.75rem;
            border-radius: 0.25rem;
        }
        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 1px solid #6c757d;
            transition: background 0.15s, color 0.15s;
        }
        .btn-outline-secondary:hover {
            background: #6c757d;
            color: #fff;
        }
        .btn-outline-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            transition: background 0.15s, color 0.15s;
        }
        .btn-outline-danger:hover {
            background: #dc3545;
            color: #fff;
        }
        .text-center {
            text-align: center;
        }
        .d-flex {
            display: flex;
        }
        .align-items-center {
            align-items: center;
        }
        .justify-content-between {
            justify-content: space-between;
        }
        .justify-content-center {
            justify-content: center;
        }
        .me-2 {
            margin-right: 0.5rem;
        }
    </style>

    <!-- Заголовок страницы -->
    <title layout:fragment="title" th:text="${title}">Проекты</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">

        <!-- ========== ФИЛЬТР ПО ТИПУ ПРОЕКТА ========== -->
        <div class="row justify-content-center mb-3">
            <div class="col-md-10">
                <form th:action="@{/projects}" method="get" class="row g-2 align-items-center">
                    <!-- Скрываем параметры сортировки -->
                    <input type="hidden" name="sortField" th:value="${sortField}"/>
                    <input type="hidden" name="sortDir"   th:value="${sortDir}"/>

                    <div class="col-auto">
                        <label for="typeSelect"><strong>Тип:</strong></label>
                    </div>
                    <div class="col-auto">
                        <select id="typeSelect" name="type" class="form-select" th:onchange="this.form.submit()">
                            <option value="all" th:selected="${type == 'all'}">— Все —</option>
                            <option value="team" th:selected="${type == 'team'}">Командные</option>
                            <option value="personal" th:selected="${type == 'personal'}">Личные</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn">Применить</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- ========== /ФИЛЬТР ПО ТИПУ ПРОЕКТА ========== -->

        <!-- ========== ТАБЛИЦА ПРОЕКТОВ ========== -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow-sm">
                    <!-- Заголовок таблицы + кнопка «Новый проект» -->
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0" th:text="${title}">Проекты</h3>
                        <a class="btn btn-success" th:href="@{/projects/new}">Новый проект</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <!-- Название + сортировка -->
                                    <th>
                                        <a th:href="@{
                                            /projects(
                                                type=${type},
                                                sortField='name',
                                                sortDir=${sortField=='name' ? reverseDir : 'asc'}
                                            )
                                        }"
                                           th:classappend="${sortField=='name'} ? (${sortDir=='asc'} ? ' text-white bg-dark' : ' text-white bg-dark') : ''">
                                            Название
                                        </a>
                                    </th>
                                    <th>
                                        <a th:href="@{
                                            /projects(
                                                type=${type},
                                                sortField='owner.username',
                                                sortDir=${sortField=='owner.username' ? reverseDir : 'asc'}
                                            )
                                        }"
                                           th:classappend="${sortField=='owner.username'} ? (${sortDir=='asc'} ? ' text-white bg-dark' : ' text-white bg-dark') : ''">
                                            Владелец
                                        </a>
                                    </th>
                                    <th>
                                        <a th:href="@{
                                            /projects(
                                                type=${type},
                                                sortField='priority',
                                                sortDir=${sortField=='priority' ? reverseDir : 'asc'}
                                            )
                                        }"
                                           th:classappend="${sortField=='priority'} ? (${sortDir=='asc'} ? ' text-white bg-dark' : ' text-white bg-dark') : ''">
                                            Приоритет
                                        </a>
                                    </th>
                                    <th>
                                        <a th:href="@{
                                            /projects(
                                                type=${type},
                                                sortField='type',
                                                sortDir=${sortField=='type' ? reverseDir : 'asc'}
                                            )
                                        }"
                                           th:classappend="${sortField=='type'} ? (${sortDir=='asc'} ? ' text-white bg-dark' : ' text-white bg-dark') : ''">
                                            Тип проекта
                                        </a>
                                    </th>
                                    <th>Действия</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Перебор списка проектов -->
                                <tr th:each="p : ${projects}">
                                    <td th:text="${p.name}">Имя проекта</td>
                                    <td th:text="${p.owner.username}">Владелец</td>
                                    <td>
                                        <span th:switch="${p.priority}">
                                            <span th:case="1">Низкий</span>
                                            <span th:case="2">Средний</span>
                                            <span th:case="3">Высокий</span>
                                            <span th:case="*">—</span>
                                        </span>
                                    </td>
                                    <td th:text="${p.team != null ? 'Командный' : 'Личный'}">Тип</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <!-- Кнопка «Просмотр» -->
                                            <a th:href="@{|/projects/${p.id}/view|}"
                                               class="btn btn-sm btn-outline-secondary me-2"
                                               title="Просмотреть">
                                                Просмотр
                                            </a>
                                            <!-- Кнопка «Удалить» (только владелец или ADMIN) -->
                                            <form th:if="${p.owner.username == #authentication.name or #authentication.principal.role == 'ROLE_ADMIN'}"
                                                  th:action="@{|/projects/${p.id}/delete|}"
                                                  method="post"
                                                  style="display: inline;">
                                                <input type="hidden"
                                                       th:name="${_csrf.parameterName}"
                                                       th:value="${_csrf.token}"/>
                                                <button type="submit"
                                                        class="btn btn-sm btn-outline-danger"
                                                        title="Удалить"
                                                        onclick="return confirm('Удалить проект?');">
                                                    Удалить
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <!-- Если проектов нет -->
                                <tr th:if="${#lists.isEmpty(projects)}">
                                    <td colspan="5" class="text-center py-3">Нет проектов</td>
                                </tr>
                                </tbody>
                            </table>
                        </div> <!-- /.table-responsive -->
                    </div> <!-- /.card-body -->
                </div> <!-- /.card -->
            </div> <!-- /.col-md-10 -->
        </div> <!-- /.row -->
        <!-- ========== /ТАБЛИЦА ПРОЕКТОВ ========== -->
    </div> <!-- /.container -->
</div> <!-- /.content -->
</body>
</html>
